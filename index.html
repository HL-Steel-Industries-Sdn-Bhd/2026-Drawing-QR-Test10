<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Drawing + Work Entry Demo</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
    * { box-sizing: border-box; margin:0; padding:0; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; padding:20px; }
    .container { background:white; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.2); width:100%; max-width:1000px; padding:30px; margin: 0 auto; }
    h2 { color:#333; text-align:center; margin-bottom:30px; font-size:28px; font-weight:600; }
    
    /* ç”µè„‘ç‰ˆå¸ƒå±€ - ä½¿ç”¨ç½‘æ ¼å¸ƒå±€ç¡®ä¿ç­‰é«˜ */
    .drawing-content {
        display: flex;
        flex-direction: column;
    }
    
    @media (min-width: 768px) {
        .drawing-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            align-items: stretch; /* å…³é”®ï¼šç¡®ä¿ç½‘æ ¼é¡¹ç­‰é«˜ */
        }
        
        .drawing-info, .scan-section {
            display: flex;
            flex-direction: column;
            height: 100%; /* å…³é”®ï¼šå¡«å……çˆ¶å®¹å™¨é«˜åº¦ */
        }
    }
    
    /* å›¾çº¸ä¿¡æ¯å¡ç‰‡æ ·å¼ */
    .drawing-card { 
        background:#f8f9fa; 
        border-radius:8px; 
        padding:25px; 
        border-left:4px solid #667eea; 
        box-shadow:0 5px 15px rgba(0,0,0,0.05);
        height: 100%; /* å…³é”®ï¼šå¡«å……çˆ¶å®¹å™¨é«˜åº¦ */
        display: flex;
        flex-direction: column;
    }
    
    /* æ‰‹æœºç‰ˆ - å‡å°‘é—´è· */
    @media (max-width: 767px) {
        .drawing-card { 
            padding:15px; 
            margin-bottom:15px; 
        }
        
        h2 {
            margin-bottom:20px;
            font-size:24px;
        }
        
        .container {
            padding:20px;
        }
    }
    
    .drawing-grid { 
        display:grid; 
        grid-template-columns: repeat(1, 1fr);
        gap:15px; 
        margin-bottom:0; 
        flex: 1; /* å…³é”®ï¼šå¡«å……å¯ç”¨ç©ºé—´ */
    }
    
    @media (min-width: 768px) {
        .drawing-grid { 
            grid-template-columns: repeat(2, 1fr); 
        }
    }
    
    .info-item { 
        display:flex; 
        flex-direction:column; 
        padding:12px;
        background: white;
        border-radius: 6px;
        border: 1px solid #eee;
        transition: all 0.3s;
    }
    
    .info-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102,126,234,0.1);
    }
    
    .info-label { 
        font-weight:500; 
        color:#555; 
        margin-bottom:4px; 
        font-size:13px; 
    }
    
    .info-value { 
        font-size:15px; 
        color:#333;
        font-weight: 500;
    }
    
    /* æ‰«æåŒºåŸŸæ ·å¼ - ç»Ÿä¸€ä½¿ç”¨è“è‰²è¾¹æ¡† */
    .scan-section {
        background:#f8f9fa; 
        border-radius:8px; 
        padding:25px; 
        text-align:center;
        border-left:4px solid #667eea; /* æ”¹ä¸ºè“è‰²è¾¹æ¡† */
        display: flex;
        flex-direction: column;
        height: 100%; /* å…³é”®ï¼šå¡«å……çˆ¶å®¹å™¨é«˜åº¦ */
    }
    
    .scan-instruction { 
        font-size:18px; 
        color:#667eea; 
        font-weight:600; 
        margin-bottom: 20px;
    }
    
    .scanner-container {
        width: 100%;
        height: 200px;
        border: 2px dashed #bbb;
        border-radius: 8px;
        position: relative;
        background-color: #f9f9f9;
        transition: all 0.3s ease;
        overflow: hidden;
        margin: 0 auto 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0; /* é˜²æ­¢å®¹å™¨è¢«å‹ç¼© */
    }
    
    /* ç”µè„‘ä¸Šçš„æ‰«æåŒºåŸŸ - æ­£æ–¹å½¢å¹¶ç¼©å°20% */
    @media (min-width: 768px) {
        .scanner-container {
            width: 180px; /* æ­£æ–¹å½¢ï¼Œç¼©å°20% */
            height: 180px;
            margin: 0 auto 20px;
        }
    }
    
    /* æ‰‹æœºä¸Šçš„æ‰«æåŒºåŸŸ - ç¡®ä¿å¯è§ */
    @media (max-width: 767px) {
        .scanner-container {
            height: 250px; /* æ¢å¤åŸæ¥çš„é«˜åº¦ */
            margin-bottom: 15px;
            width: 100%;
        }
        
        .scan-section {
            padding:15px;
            margin-top: 15px;
        }
    }
    
    /* è™šçº¿æ¡†æ¡†æç¤º */
    .dashed-box {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #777;
        font-size: 14px;
    }
    
    .dashed-box i {
        font-size: 40px;
        margin-bottom: 10px;
        color: #667eea;
    }
    
    #reader {
        width: 100%;
        height: 100%;
    }
    
    /* GIFå®¹å™¨ */
    .gif-container {
        text-align: center;
        margin-top: auto; /* å…³é”®ï¼šæ¨åˆ°å®¹å™¨åº•éƒ¨ */
        padding-top: 15px;
        border-top: 1px solid #eee;
    }
    
    .gif-container p {
        margin-bottom: 10px;
        color:#555;
        font-size: 14px;
    }
    
    .gif-container img {
        width: 130px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    /* å·¥ä½œèµ„æ–™éƒ¨åˆ† - æ–°è®¾è®¡ */
    .work-section {
        display: none;
    }
    
    /* ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º */
    #userDisplay {
        background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 25px;
        font-size: 1.2rem;
        text-align: center;
        box-shadow: 0 5px 15px rgba(102,126,234,0.3);
        font-weight: 600;
    }
    
    /* å¡ç‰‡å †å åˆ‡æ¢æ ·å¼ */
    .card-stack-container {
        display: flex;
        flex-direction: column;
        gap: 30px;
        margin-bottom: 30px;
    }
    
    @media (min-width: 768px) {
        .card-stack-container {
            flex-direction: row;
            gap: 40px;
        }
        
        .stack-section {
            flex: 1;
        }
        
        .info-sidebar {
            width: 300px;
            flex-shrink: 0;
        }
    }
    
    .stack-container {
        position: relative;
        width: 100%;
        height: 170px;
        touch-action: pan-y;
        margin-bottom: 20px;
    }
    
    .card-box {
        position: absolute;
        inset: 0;
        border-radius: 14px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        font-size: 20px;
        font-weight: bold;
        cursor: pointer;
        user-select: none;
        transition:
            transform 0.45s ease,
            opacity 0.45s ease,
            box-shadow 0.45s ease;
        color: #333;
        text-align: center;
        padding: 20px;
    }
    
    /* å›ºå®šé¢œè‰² */
    .c1 { background: #87CEEB; } /* æµ…è“ - Received From */
    .c2 { background: #D8BFD8; } /* æµ…ç´« - Job Completed */
    .c3 { background: #FFB6C1; } /* æµ…çº¢ - Quality Control */
    
    .card-english {
        font-size: 22px;
        margin-bottom: 5px;
    }
    
    .card-chinese {
        font-size: 16px;
        font-weight: normal;
    }
    
    /* å†…å®¹iframeåŒºåŸŸ */
    .content-frame {
        width: 100%;
        height: 400px;
        border-radius: 10px;
        border: 2px solid #ddd;
        background: #fff;
        padding: 20px;
        overflow-y: auto;
    }
    
    .frame-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 2px solid #667eea;
    }
    
    /* é€‰é¡¹æ ·å¼ */
    .option-item {
        display: flex;
        align-items: flex-start;
        margin-bottom: 12px;
        padding: 10px;
        border-radius: 6px;
        transition: background-color 0.2s;
    }
    
    .option-item:hover {
        background-color: #f5f5f5;
    }
    
    .option-checkbox {
        margin-right: 12px;
        margin-top: 3px;
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    .option-label {
        flex: 1;
        cursor: pointer;
    }
    
    .option-english {
        font-size: 15px;
        color: #333;
        margin-bottom: 3px;
    }
    
    .option-chinese {
        font-size: 13px;
        color: #666;
    }
    
    /* å¯†ç è¾“å…¥åŒºåŸŸ */
    .password-section {
        margin-top: 20px;
        padding: 20px;
        background: #f9f9f9;
        border-radius: 8px;
        border: 1px solid #ddd;
    }
    
    .password-input {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .password-input input {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 16px;
        flex: 1;
    }
    
    .password-input button {
        padding: 10px 20px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
    }
    
    /* ä¿¡æ¯ä¾§è¾¹æ  */
    .info-sidebar {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        border-left: 4px solid #667eea;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    
    .sidebar-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin-bottom: 20px;
        text-align: center;
    }
    
    .sidebar-item {
        margin-bottom: 20px;
    }
    
    .sidebar-label {
        font-weight: 500;
        color: #555;
        margin-bottom: 5px;
        font-size: 14px;
    }
    
    .sidebar-value {
        font-size: 16px;
        color: #333;
        font-weight: 500;
        background: white;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #eee;
    }
    
    /* æäº¤æŒ‰é’® */
    .submit-section {
        text-align: center;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }
    
    .submit-btn { 
        background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); 
        color:white; 
        border:none;
        padding:14px 40px; 
        border-radius:6px; 
        font-size:16px; 
        font-weight:600; 
        cursor:pointer; 
        transition:all 0.3s; 
        min-width: 200px;
    }
    
    .submit-btn:hover:not(:disabled) { 
        transform:translateY(-2px); 
        box-shadow:0 5px 15px rgba(102,126,234,0.4); 
    }
    
    .submit-btn:disabled { 
        background:#cccccc; 
        cursor: not-allowed;
    }
    
    .submit-btn:active:not(:disabled) { 
        transform:translateY(0); 
    }
    
    .success-message {
        margin-top: 15px;
        padding: 12px;
        background: #d4edda;
        color: #155724;
        border-radius: 6px;
        border: 1px solid #c3e6cb;
        display: none;
    }
    
    /* éšè—çš„æ‰«ç è¾“å…¥æ¡† */
    #scannerInput {
        opacity: 0;
        position: absolute;
        left: -9999px;
    }
    
    /* å“åº”å¼è°ƒæ•´ */
    @media (max-width: 600px) {
        .container { padding:15px; }
        h2 { font-size:22px; margin-bottom:15px; }
        .card-stack-container {
            flex-direction: column;
        }
        .info-sidebar {
            width: 100%;
        }
        .content-frame {
            height: 350px;
            padding: 15px;
        }
    }
    
    .section {
        display: none;
    }
    
    #drawingSection {
        display: block;
    }
    
    /* æ–°å¢ï¼šç”µè„‘ç‰ˆæ‘„åƒå¤´åˆ‡æ¢æŒ‰é’®æ ·å¼ */
    .camera-toggle-container {
        margin: 15px 0;
        text-align: center;
    }
    
    .camera-toggle-btn {
        background: #4CAF50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        margin: 5px;
    }
    
    .camera-toggle-btn:hover {
        background: #45a049;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .camera-toggle-btn.stop {
        background: #f44336;
    }
    
    .camera-toggle-btn.stop:hover {
        background: #d32f2f;
    }
    
    .scanner-method {
        font-size: 14px;
        color: #666;
        margin-top: 10px;
        padding: 8px;
        background: #f0f0f0;
        border-radius: 4px;
        display: inline-block;
    }
    
    /* æ–°å¢ï¼šç”µè„‘ç‰ˆæ‘„åƒå¤´æ‰«ææç¤º */
    .camera-instruction {
        font-size: 14px;
        color: #2196F3;
        margin: 10px 0;
        font-weight: 500;
    }
    
    .scanner-options {
        display: flex;
        justify-content: center;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 15px;
    }
</style>
</head>
<body>
<div class="container">
  <!-- ===== éšè— input ç”¨äºç”µè„‘ scanner ===== -->
  <input type="text" id="scannerInput" autofocus>

  <!-- ===== é˜¶æ®µ 1ï¼šå›¾çº¸ä¿¡æ¯ ===== -->
  <div id="drawingSection" class="section" style="display:block;">
    <h2>ğŸ“‹ Drawing Information</h2>
    
    <div class="drawing-content">
        <div class="drawing-info">
            <div class="drawing-card">
                <div class="drawing-grid">
                    <div class="info-item">
                        <div class="info-label">Sales Order No.</div>
                        <div class="info-value">SO-009999</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Item No.</div>
                        <div class="info-value">20</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Customer Name</div>
                        <div class="info-value">Fujimak</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Item Name</div>
                        <div class="info-value">S/S Table</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Dimension</div>
                        <div class="info-value">L 870mm x W 760mm x H 50mm</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Quantity</div>
                        <div class="info-value">1</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Unit of Measurement</div>
                        <div class="info-value">Set</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Estimated Delivery Date</div>
                        <div class="info-value">15/01/2025</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="scan-section">
            <div class="scan-instruction">Please scan your <b>Credential QR Code</b></div>
            
            <!-- ç”µè„‘ç‰ˆæ‰«ç æ–¹å¼é€‰æ‹© -->
            <div class="scanner-options" id="scannerOptions" style="display: none;">
                <div class="scanner-method">Choose scanning method:</div>
            </div>
            
            <!-- æ‘„åƒå¤´åˆ‡æ¢æŒ‰é’® -->
            <div class="camera-toggle-container" id="cameraToggleContainer" style="display: none;">
                <button class="camera-toggle-btn" id="cameraToggleBtn">ğŸ“· Use Camera to Scan</button>
            </div>
            
            <!-- æ‘„åƒå¤´æ‰«ææç¤º -->
            <div class="camera-instruction" id="cameraInstruction" style="display: none;">
                Camera mode: Point camera at QR code
            </div>
            
            <div class="scanner-container" id="scannerContainer">
                <div class="dashed-box" id="dashedBox">
                    <div style="font-size: 24px;">ğŸ“±</div>
                    <div>QR Code Scanner Area</div>
                    <div style="font-size: 12px; margin-top: 5px;">è™šçº¿æ¡†æ¡† - æ‰‹æœºæ‰«ç åŒºåŸŸ</div>
                </div>
                <div id="reader"></div>
            </div>

            <div class="gif-container" id="gifContainer">
                <p>Use your scanner to scan the Credential QR Code</p>
                <img src="https://media.giphy.com/media/3o6ZtaO9BZHcOjmErm/giphy.gif" alt="Scanner GIF">
            </div>
        </div>
    </div>
  </div>

  <!-- ===== é˜¶æ®µ 2ï¼šå·¥ä½œæ•°æ®å½•å…¥é¡µé¢ ===== -->
  <div id="workSection" class="section">
    <h2>ğŸ“ Work Data Entry</h2>
    
    <div id="userDisplay">Current User: Cyril</div>
    
    <div class="card-stack-container">
        <div class="stack-section">
            <!-- å¡ç‰‡å †å åˆ‡æ¢ -->
            <div class="stack-container" id="stack">
                <div class="card-box c1">
                    <div class="card-english">Received From</div>
                    <div class="card-chinese">ä»å“ªæ”¶åˆ°</div>
                </div>
                <div class="card-box c2">
                    <div class="card-english">Job Completed</div>
                    <div class="card-chinese">å·²å®Œæˆçš„å·¥ä½œ</div>
                </div>
                <div class="card-box c3">
                    <div class="card-english">Quality Control</div>
                    <div class="card-chinese">è´¨é‡æ£€æŸ¥</div>
                </div>
            </div>
            
            <!-- å†…å®¹åŒºåŸŸ -->
            <div class="content-frame" id="contentFrame">
                <!-- å†…å®¹ä¼šé€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>
            
            <!-- æäº¤æŒ‰é’® -->
            <div class="submit-section">
                <button id="submitBtn" class="submit-btn">Submit Data</button>
                <div id="successMessage" class="success-message">
                    âœ… Data successfully submitted!
                </div>
            </div>
        </div>
        
        <!-- å³ä¾§ä¿¡æ¯ä¾§è¾¹æ  -->
        <div class="info-sidebar">
            <div class="sidebar-title">Last User Information</div>
            <div class="sidebar-item">
                <div class="sidebar-label">Last User</div>
                <div class="sidebar-value">Cyril</div>
            </div>
            <div class="sidebar-item">
                <div class="sidebar-label">Last User Status</div>
                <div class="sidebar-value">Received From</div>
            </div>
            <div class="sidebar-item">
                <div class="sidebar-label">Last User Selection</div>
                <div class="sidebar-value">Received from Laser Cutting - ä»æ¿€å…‰åˆ‡å‰²éƒ¨æ”¶åˆ°</div>
            </div>
        </div>
    </div>
  </div>
</div>

<script>
function isMobile() {
  return /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
}

// å…¨å±€å˜é‡
let scannerContainer, dashedBox, gifContainer, drawingSection, workSection, scannerInput;
let cameraToggleContainer, cameraToggleBtn, cameraInstruction, scannerOptions;
let currentUser = "";
let currentCardIndex = 0;
let selectedOptions = {
  receivedFrom1: null,
  receivedFrom2: null,
  jobCompleted: null,
  qualityControl: null
};
let isSubmitted = false;
let qcUnlocked = false;
let html5QrcodeScanner = null;
let isCameraActive = false;

// å¡ç‰‡å†…å®¹å’Œiframeæ•°æ®
const cardContents = [
  { // Received From
    title: "Received From ä»å“ªæ”¶åˆ°",
    frames: [
      {
        title: "Received From ä»å“ªæ”¶åˆ°",
        options: [
          {id: "rf1-1", en: "Received 3D Drawing (Completely Stamped)", cn: "æ”¶åˆ°å®Œæ•´ç›–ç« çš„ç«‹ä½“å›¾"},
          {id: "rf1-2", en: "Received Checked 3D Drawing from Supervisor", cn: "ä»å¤´æ‰‹é‚£æ”¶åˆ°å·²æ£€æŸ¥çš„ç«‹ä½“å›¾"},
          {id: "rf1-3", en: "Received 2D Drawing from Drawing Department", cn: "ä»ç»˜å›¾éƒ¨æ”¶åˆ°å±•å¼€å›¾"},
          {id: "rf1-4", en: "Received Checked 2D Drawing from Supervisor", cn: "ä»å¤´æ‰‹é‚£æ”¶åˆ°å·²æ£€æŸ¥çš„å±•å¼€å›¾"},
          {id: "rf1-5", en: "Received Stamped 2D Drawing from Document Control", cn: "ä»æ–‡ä»¶ç®¡ç†éƒ¨æ”¶åˆ°å·²ç›–ç« çš„å±•å¼€å›¾"},
          {id: "rf1-6", en: "Received from Laser Cutting", cn: "ä»æ¿€å…‰åˆ‡å‰²éƒ¨æ”¶åˆ°"},
          {id: "rf1-7", en: "Received from V Cut", cn: "ä»Væ§½åˆ‡å‰²æœºæ”¶åˆ°"},
          {id: "rf1-8", en: "Received from Bending", cn: "ä»å‡¹æ¿éƒ¨æ”¶åˆ°"},
          {id: "rf1-9", en: "Received from Cutting", cn: "ä»åˆ‡å‰²éƒ¨æ”¶åˆ°"},
          {id: "rf1-10", en: "Received from Welding & Assembly", cn: "ä»ç„Šæ¥ä¸ç»„è£…éƒ¨æ”¶åˆ°"},
          {id: "rf1-11", en: "Received from Polishing", cn: "ä»æŠ›å…‰éƒ¨æ”¶åˆ°"},
          {id: "rf1-12", en: "Received from Acid Wash", cn: "ä»åŒ–å­¦æ¸…æ´—éƒ¨æ”¶åˆ°"},
          {id: "rf1-13", en: "Received from Electrical Work", cn: "ä»ç”µå·¥éƒ¨æ”¶åˆ°"},
          {id: "rf1-14", en: "Received from Gas Fitting", cn: "ä»æ¥æ°”ç®¡éƒ¨æ”¶åˆ°"},
          {id: "rf1-15", en: "Received from Plumbing Job", cn: "ä»æ¥æ°´ç®¡éƒ¨æ”¶åˆ°"},
          {id: "rf1-16", en: "Received from Quality Control", cn: "ä»è´¨æ£€éƒ¨æ”¶åˆ°"},
          {id: "rf1-17", en: "Received from Packaging", cn: "ä»åŒ…è£…éƒ¨æ”¶åˆ°"},
          {id: "rf1-18", en: "Received from Finished Goods Labeling", cn: "ä»æˆå“æ ‡ç­¾éƒ¨æ”¶åˆ°"},
          {id: "rf1-19", en: "Received Order from Marketing Department to Deliver Product to Sub-Contractor", cn: "ä»æˆå“æ ‡ç­¾éƒ¨æ”¶åˆ°"},
          {id: "rf1-20", en: "Received Order from Marketing Department to Bring Back Processed Product", cn: "ä»å¸‚åœºéƒ¨æ”¶åˆ°æŒ‡ä»¤æŠŠä»£å·¥/åˆ†åŒ…å•†å¤„ç†å¥½çš„äº§å“æ‹¿å›æ¥"},
          {id: "rf1-21", en: "Received Product from Sub Contractor", cn: "ä»ä»£å·¥/åˆ†åŒ…å•†æ”¶åˆ°äº§å“"}
        ]
      },
      {
        title: "Check æ£€æŸ¥",
        options: [
          {id: "rf2-1", en: "Pass", cn: "è¿‡å…³"},
          {id: "rf2-2", en: "Deficiencies", cn: "ä¸è¶³ä¹‹å¤„"}
        ],
        hasInput: true
      }
    ]
  },
  { // Job Completed
    title: "Job Completed å·²å®Œæˆçš„å·¥ä½œ",
    frames: [
      {
        title: "Job Completed å·²å®Œæˆçš„å·¥ä½œ",
        options: [
          {id: "jc1-1", en: "QR Code Creation", cn: "äºŒç»´ç åˆ›å»º"},
          {id: "jc1-2", en: "Document Control: Checked & Stamped", cn: "æ–‡ä»¶ç®¡ç†: æ£€æŸ¥ç›–ç« "},
          {id: "jc1-3", en: "Project Department: Explained & Passed Drawing", cn: "é¡¹ç›®éƒ¨: è®²è§£ & ä¸‹å›¾"},
          {id: "jc1-4", en: "Supervisor: Checked 3D Drawing", cn: "å¤´æ‰‹: å®Œæˆç«‹ä½“å›¾çš„æ£€æŸ¥"},
          {id: "jc1-5", en: "2D Drawing", cn: "å±•å¼€å›¾"},
          {id: "jc1-6", en: "Supervisor: Checked & Signed on 2D Drawing", cn: "å¤´æ‰‹: å®Œæˆå±•å¼€å›¾çš„æ£€æŸ¥å¹¶ç­¾å"},
          {id: "jc1-7", en: "Laser Cutting", cn: "æ¿€å…‰åˆ‡å‰² Skip to question 29"},
          {id: "jc1-8", en: "V Cut", cn: "Væ§½åˆ‡å‰² Skip to question 29"},
          {id: "jc1-9", en: "Bending", cn: "å‡¹æ¿ Skip to question 29"},
          {id: "jc1-10", en: "Cutting", cn: "åˆ‡å‰² Skip to question 29"},
          {id: "jc1-11", en: "Welding & Assembly", cn: "ç„Šæ¥ä¸ç»„è£… Skip to question 29"},
          {id: "jc1-12", en: "Painting", cn: "ä¸Šæ¼† Skip to question 29"},
          {id: "jc1-13", en: "Polishing", cn: "æŠ›å…‰ Skip to question 29"},
          {id: "jc1-14", en: "Acid Wash", cn: "åŒ–å­¦æ¸…æ´— Skip to question 29"},
          {id: "jc1-15", en: "Electrical Work", cn: "ç”µå·¥ Skip to question 29"},
          {id: "jc1-16", en: "Gas Fitting", cn: "æ°”ç®¡å·¥ Skip to question 29"},
          {id: "jc1-17", en: "Plumbing Job", cn: "æ°´ç®¡å·¥ Skip to question 29"},
          {id: "jc1-18", en: "Quality Control", cn: "è´¨æ£€ Skip to question 29"},
          {id: "jc1-19", en: "Packaging", cn: "åŒ…è£… Skip to question 29"},
          {id: "jc1-20", en: "Finished Goods Labeling", cn: "ç»™æˆå“è´´æ ‡ç­¾ Skip to question 29"},
          {id: "jc1-21", en: "Deliver Product to Sub-Contractor", cn: "é€äº§å“åˆ°ä»£å·¥/åˆ†åŒ…å•†"},
          {id: "jc1-22", en: "Bring Back Processed Product from Sub-Contractor", cn: "ä»ä»£å·¥/åˆ†åŒ…å•†æ‹¿å›å¤„ç†å¥½çš„äº§å“"},
          {id: "jc1-23", en: "Shipping Out", cn: "å‡ºè´§"},
          {id: "jc1-24", en: "QC, Marketing & Supervisor U", cn: "è´¨æ£€ã€å¸‚åœºéƒ¨å’Œå¤´æ‰‹U"}
        ]
      }
    ]
  },
  { // Quality Control
    title: "Quality Control è´¨é‡æ£€æŸ¥",
    frames: [
      {
        title: "Quality Control è´¨é‡æ£€æŸ¥",
        options: [
          {id: "qc1-1", en: "Visual Inspection Passed", cn: "ç›®è§†æ£€æŸ¥é€šè¿‡"},
          {id: "qc1-2", en: "Measurement Check Completed", cn: "å°ºå¯¸æ£€æŸ¥å®Œæˆ"},
          {id: "qc1-3", en: "Documentation Verified", cn: "æ–‡ä»¶éªŒè¯å®Œæˆ"}
        ],
        locked: true
      }
    ]
  }
];

function handleCredentialScan(user) {
  // åœæ­¢æ‘„åƒå¤´æ‰«æï¼ˆå¦‚æœæ­£åœ¨è¿è¡Œï¼‰
  if (isCameraActive && html5QrcodeScanner) {
    stopCameraScanner();
  }
  
  // éšè—å›¾çº¸ä¿¡æ¯ï¼Œæ˜¾ç¤ºå·¥ä½œæ•°æ®å½•å…¥é¡µé¢
  drawingSection.style.display = "none";
  workSection.style.display = "block";
  currentUser = user;
  document.getElementById("userDisplay").textContent = `Current User: ${user}`;
  
  // åˆå§‹åŒ–å¡ç‰‡å †å 
  initCardStack();
  renderCardContent();
}

function resetToDrawing() {
  workSection.style.display = "none";
  drawingSection.style.display = "block";
}

// å¯åŠ¨æ‘„åƒå¤´æ‰«æ
function startCameraScanner() {
  if (html5QrcodeScanner) {
    return; // å·²ç»å¯åŠ¨
  }
  
  // æ¸…é™¤è™šçº¿æ¡†æ¡†
  dashedBox.style.display = "none";
  gifContainer.style.display = "none";
  
  // åˆ›å»ºæ‘„åƒå¤´æ‰«æå™¨
  html5QrcodeScanner = new Html5Qrcode("reader");
  
  // å¯åŠ¨æ‘„åƒå¤´
  html5QrcodeScanner.start(
    { facingMode: "environment" },
    { 
      fps: 10, 
      qrbox: { width: 180, height: 180 }
    },
    (decodedText) => {
      console.log("Camera scanned:", decodedText);
      if (decodedText === "Cyril") {
        handleCredentialScan("Cyril");
      } else {
        alert("Unknown user QR. Please scan a valid credential.");
      }
    },
    (errorMessage) => {
      // å¿½ç•¥è§£æé”™è¯¯
    }
  ).catch(err => {
    console.error("Camera error:", err);
    alert("Camera initialization failed. Please check camera permissions.");
    stopCameraScanner();
  });
  
  // æ›´æ–°UIçŠ¶æ€
  isCameraActive = true;
  cameraToggleBtn.textContent = "âŒ Stop Camera";
  cameraToggleBtn.classList.add("stop");
  cameraInstruction.style.display = "block";
}

// åœæ­¢æ‘„åƒå¤´æ‰«æ
function stopCameraScanner() {
  if (html5QrcodeScanner && isCameraActive) {
    html5QrcodeScanner.stop().then(() => {
      console.log("Camera stopped");
      html5QrcodeScanner.clear();
      html5QrcodeScanner = null;
      
      // æ¢å¤è™šçº¿æ¡†æ¡†
      dashedBox.style.display = "flex";
      gifContainer.style.display = "block";
      
      // æ›´æ–°UIçŠ¶æ€
      isCameraActive = false;
      cameraToggleBtn.textContent = "ğŸ“· Use Camera to Scan";
      cameraToggleBtn.classList.remove("stop");
      cameraInstruction.style.display = "none";
      
      // é‡æ–°èšç„¦åˆ°æ‰«æä»ªè¾“å…¥æ¡†
      scannerInput.focus();
    }).catch(err => {
      console.error("Stop camera error:", err);
    });
  }
}

// æ‘„åƒå¤´åˆ‡æ¢æŒ‰é’®äº‹ä»¶
function toggleCameraScanner() {
  if (!isCameraActive) {
    startCameraScanner();
  } else {
    stopCameraScanner();
  }
}

// å¡ç‰‡å †å åŠŸèƒ½
function initCardStack() {
  const boxes = document.querySelectorAll('.card-box');
  const stack = document.getElementById('stack');
  
  function render() {
    boxes.forEach((box, i) => {
      const offset = (i - currentCardIndex + boxes.length) % boxes.length;

      if (offset === 0) {
        box.style.transform = 'translate(0,0) scale(1)';
        box.style.opacity = '1';
        box.style.zIndex = 10;
        box.style.boxShadow = '0 18px 40px rgba(0,0,0,0.25)';
      } else {
        box.style.transform =
          `translate(${offset * 18}px, ${-offset * 12}px) scale(${1 - offset * 0.04})`;
        box.style.opacity = '0.85';
        box.style.zIndex = 10 - offset;
        box.style.boxShadow = '0 8px 20px rgba(0,0,0,0.12)';
      }
    });

    renderCardContent();
  }

  function next() {
    currentCardIndex = (currentCardIndex + 1) % boxes.length;
    render();
  }

  // ç‚¹å‡»åˆ‡æ¢
  boxes.forEach(box => {
    box.addEventListener('click', next);
  });

  // Swipe æ”¯æŒ
  let startX = 0;

  stack.addEventListener('touchstart', e => {
    startX = e.touches[0].clientX;
  });

  stack.addEventListener('touchend', e => {
    const endX = e.changedTouches[0].clientX;
    if (Math.abs(endX - startX) > 40) {
      next();
    }
  });

  // åˆå§‹åŒ–æ¸²æŸ“
  render();
}

// æ¸²æŸ“å¡ç‰‡å†…å®¹
function renderCardContent() {
  const contentFrame = document.getElementById('contentFrame');
  const currentCard = cardContents[currentCardIndex];
  
  let contentHTML = `<div class="frame-title">${currentCard.title}</div>`;
  
  if (currentCardIndex === 0) { // Received From
    contentHTML += `
      <div style="margin-bottom: 25px;">
        <div style="font-weight: 600; margin-bottom: 10px; color: #333;">${currentCard.frames[0].title}:</div>
        ${renderOptions(currentCard.frames[0].options, 'receivedFrom1')}
      </div>
      <div>
        <div style="font-weight: 600; margin-bottom: 10px; color: #333;">${currentCard.frames[1].title}:</div>
        ${renderOptions(currentCard.frames[1].options, 'receivedFrom2')}
        ${currentCard.frames[1].hasInput ? `
          <div id="deficiencyInput" style="margin-top: 15px; display: none;">
            <div style="margin-bottom: 8px; font-weight: 500; color: #555;">Deficiency Details (ä¸è¶³ä¹‹å¤„è¯¦æƒ…):</div>
            <input type="text" id="deficiencyText" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;" placeholder="Enter deficiency details here...">
          </div>
        ` : ''}
      </div>
    `;
  } else if (currentCardIndex === 1) { // Job Completed
    contentHTML += `
      <div>
        ${renderOptions(currentCard.frames[0].options, 'jobCompleted')}
      </div>
    `;
  } else if (currentCardIndex === 2) { // Quality Control
    if (!qcUnlocked) {
      contentHTML += `
        <div style="text-align: center; padding: 40px 20px;">
          <div style="font-size: 18px; color: #666; margin-bottom: 20px;">Quality Control section is locked</div>
          <div class="password-section">
            <div style="margin-bottom: 10px; color: #555;">Enter password to unlock:</div>
            <div class="password-input">
              <input type="password" id="qcPassword" placeholder="Enter password...">
              <button onclick="checkQCPassword()">Unlock</button>
            </div>
            <div id="passwordError" style="color: #e74c3c; margin-top: 10px; display: none;">Incorrect password. Try again.</div>
          </div>
        </div>
      `;
    } else {
      contentHTML += `
        <div>
          ${renderOptions(currentCard.frames[0].options, 'qualityControl')}
        </div>
      `;
    }
  }
  
  contentFrame.innerHTML = contentHTML;
  
  // æ·»åŠ é€‰é¡¹é€‰æ‹©äº‹ä»¶ç›‘å¬
  addOptionListeners();
  
  // å¦‚æœæœ‰å·²é€‰æ‹©çš„é€‰é¡¹ï¼Œæ¢å¤é€‰æ‹©çŠ¶æ€
  restoreSelectedOptions();
}

// æ¸²æŸ“é€‰é¡¹åˆ—è¡¨
function renderOptions(options, category) {
  let html = '';
  options.forEach(option => {
    html += `
      <div class="option-item" data-id="${option.id}" data-category="${category}">
        <input type="radio" name="${category}" id="${option.id}" class="option-checkbox">
        <label for="${option.id}" class="option-label">
          <div class="option-english">${option.en}</div>
          <div class="option-chinese">${option.cn}</div>
        </label>
      </div>
    `;
  });
  return html;
}

// æ·»åŠ é€‰é¡¹é€‰æ‹©äº‹ä»¶ç›‘å¬
function addOptionListeners() {
  document.querySelectorAll('.option-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const optionId = this.id;
      const category = this.name;
      
      // ä¿å­˜é€‰æ‹©
      selectedOptions[category] = optionId;
      
      // å¦‚æœæ˜¯Received Fromçš„Deficienciesé€‰é¡¹ï¼Œæ˜¾ç¤ºè¾“å…¥æ¡†
      if (optionId === 'rf2-2') {
        document.getElementById('deficiencyInput').style.display = 'block';
      } else if (category === 'receivedFrom2' && optionId !== 'rf2-2') {
        document.getElementById('deficiencyInput').style.display = 'none';
      }
      
      // æ›´æ–°æäº¤æŒ‰é’®çŠ¶æ€
      updateSubmitButton();
    });
  });
}

// æ¢å¤å·²é€‰æ‹©çš„é€‰é¡¹
function restoreSelectedOptions() {
  Object.keys(selectedOptions).forEach(category => {
    const optionId = selectedOptions[category];
    if (optionId) {
      const checkbox = document.getElementById(optionId);
      if (checkbox) {
        checkbox.checked = true;
        
        // å¦‚æœæ˜¯Deficienciesé€‰é¡¹ï¼Œæ˜¾ç¤ºè¾“å…¥æ¡†
        if (optionId === 'rf2-2') {
          const deficiencyInput = document.getElementById('deficiencyInput');
          if (deficiencyInput) deficiencyInput.style.display = 'block';
        }
      }
    }
  });
}

// æ£€æŸ¥QCå¯†ç 
function checkQCPassword() {
  const passwordInput = document.getElementById('qcPassword');
  const passwordError = document.getElementById('passwordError');
  
  if (passwordInput.value === '1234') {
    qcUnlocked = true;
    renderCardContent();
  } else {
    passwordError.style.display = 'block';
    passwordInput.value = '';
  }
}

// æ›´æ–°æäº¤æŒ‰é’®çŠ¶æ€
function updateSubmitButton() {
  const submitBtn = document.getElementById('submitBtn');
  
  // æ£€æŸ¥å½“å‰å¡ç‰‡æ˜¯å¦æœ‰é€‰æ‹©
  let hasSelection = false;
  if (currentCardIndex === 0) { // Received From
    hasSelection = selectedOptions.receivedFrom1 && selectedOptions.receivedFrom2;
  } else if (currentCardIndex === 1) { // Job Completed
    hasSelection = selectedOptions.jobCompleted !== null;
  } else if (currentCardIndex === 2) { // Quality Control
    hasSelection = qcUnlocked && selectedOptions.qualityControl !== null;
  }
  
  submitBtn.disabled = !hasSelection || isSubmitted;
}

// æäº¤æ•°æ®
function submitData() {
  if (isSubmitted) return;
  
  const successMessage = document.getElementById('successMessage');
  const submitBtn = document.getElementById('submitBtn');
  
  // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
  successMessage.style.display = 'block';
  
  // ç¦ç”¨æäº¤æŒ‰é’®
  submitBtn.disabled = true;
  isSubmitted = true;
  
  // è®°å½•æäº¤æ•°æ®
  console.log('Data submitted:', {
    user: currentUser,
    cardIndex: currentCardIndex,
    selectedOptions: selectedOptions,
    timestamp: new Date().toISOString()
  });
}

// é¡µé¢åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
  scannerContainer = document.getElementById("scannerContainer");
  dashedBox = document.getElementById("dashedBox");
  gifContainer = document.getElementById("gifContainer");
  drawingSection = document.getElementById("drawingSection");
  workSection = document.getElementById("workSection");
  scannerInput = document.getElementById("scannerInput");
  
  // æ–°å¢å…ƒç´ 
  cameraToggleContainer = document.getElementById("cameraToggleContainer");
  cameraToggleBtn = document.getElementById("cameraToggleBtn");
  cameraInstruction = document.getElementById("cameraInstruction");
  scannerOptions = document.getElementById("scannerOptions");
  
  // ç»‘å®šæäº¤æŒ‰é’®äº‹ä»¶
  document.getElementById('submitBtn').addEventListener('click', submitData);
  
  // ç»‘å®šæ‘„åƒå¤´åˆ‡æ¢æŒ‰é’®äº‹ä»¶
  cameraToggleBtn.addEventListener('click', toggleCameraScanner);
  
  if (isMobile()) {
    // æ‰‹æœºæ‰“å¼€ï¼Œæ˜¾ç¤ºæ‘„åƒå¤´æ‰«ç 
    scannerContainer.style.display = "block";
    dashedBox.style.display = "none";
    gifContainer.style.display = "none";
    
    const html5QrcodeScanner = new Html5Qrcode("reader");

    html5QrcodeScanner.start(
      { facingMode: "environment" },
      { 
        fps: 10, 
        qrbox: { width: 250, height: 250 }
      },
      (decodedText) => {
        console.log("Scanned:", decodedText);
        if(decodedText === "Cyril") {
          html5QrcodeScanner.stop();
          handleCredentialScan("Cyril");
        } else {
          alert("Unknown user QR. Please scan a valid credential.");
        }
      }
    ).catch(err => {
      console.error(err);
      alert("Camera initialization failed. Please check camera permissions.");
    });

  } else {
    // ç”µè„‘æ‰“å¼€ï¼Œæ˜¾ç¤ºè™šçº¿æ¡†æ¡†å’ŒGIFæç¤º
    scannerContainer.style.display = "block";
    dashedBox.style.display = "flex";
    gifContainer.style.display = "block";
    
    // æ˜¾ç¤ºç”µè„‘ç‰ˆä¸“å±UIå…ƒç´ 
    cameraToggleContainer.style.display = "block";
    scannerOptions.style.display = "block";

    // æ¯æ¬¡ç‚¹å‡»é¡µé¢éƒ½ focus éšè—è¾“å…¥æ¡†ï¼Œä¿è¯ scanner è¾“å…¥èƒ½æ•è·
    document.addEventListener("click", () => scannerInput.focus());

    // ç›‘å¬ scanner è¾“å…¥
    scannerInput.addEventListener("keydown", (e) => {
      if(e.key === "Enter") {
        const value = scannerInput.value.trim();
        scannerInput.value = "";
        if(value === "Cyril") {
          handleCredentialScan("Cyril");
        } else {
          alert("Unknown user. Please scan a valid credential QR code.");
        }
      }
    });

    // é¡µé¢åŠ è½½åè‡ªåŠ¨ focus è¾“å…¥æ¡†
    window.onload = () => {
      scannerInput.focus();
    };
  }
});
</script>
</body>
</html>
